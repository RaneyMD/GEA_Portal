<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEA Member Portal</title>
    
    <!-- ============================================================ -->
    <!-- FAVICON: Shown in browser tab                               -->
    <!-- References Config.gs FAVICON_URL constant                  -->
    <!-- ============================================================ -->
    <link rel="icon" type="image/x-icon" href="<?= FAVICON_URL ?>">
    
    <!-- ============================================================ -->
    <!-- GOOGLE FONTS: Source Sans 3 for UI, Roboto Mono for data  -->
    <!-- Per gea-brand SKILL.md typography section                 -->
    <!-- ============================================================ -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================================ */
        /* RESET & BASE STYLES                                         */
        /* ============================================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Sans 3', 'Segoe UI', Arial, sans-serif;
            font-size: 14px;
            color: #333333;
            background-color: #F5F5F5;
            line-height: 1.5;
        }
        
        /* ============================================================ */
        /* COLOR VARIABLES: From gea-brand SKILL.md palette           */
        /* ============================================================ */
        :root {
            --color-primary: #0A3161;           /* Old Glory Blue */
            --color-accent: #B31942;            /* Old Glory Red */
            --color-white: #FFFFFF;
            --color-success: #2E7D32;           /* Approved, confirmed, valid */
            --color-warning: #E65100;           /* Pending, tentative */
            --color-danger: #C62828;            /* Denied, cancelled, urgent */
            --color-info: #1565C0;              /* Informational */
            --color-light-gray: #F5F5F5;        /* Page background */
            --color-medium-gray: #757575;       /* Secondary text */
            --color-border-gray: #E0E0E0;       /* Dividers, borders */
            --color-botswana-blue: #ABCAE9;     /* Info boxes */
        }
        
        /* ============================================================ */
        /* HEADER / NAV BAR                                            */
        /* Per gea-brand SKILL.md: dark nav with logo and user info  */
        /* ============================================================ */
        .header {
            background-color: var(--color-primary);
            border-bottom: 4px solid var(--color-accent);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: var(--color-white);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .logo img {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .header-title {
            color: var(--color-white);
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .user-info {
            text-align: right;
            color: var(--color-white);
        }
        
        .user-label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #B0D4F1;
            margin-bottom: 2px;
        }
        
        .user-name {
            font-size: 14px;
            font-weight: 600;
        }
        
        .household-name {
            font-size: 12px;
            color: #B0D4F1;
            margin-top: 2px;
        }
        
        .logout-button {
            background-color: var(--color-accent);
            color: var(--color-white);
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .logout-button:hover {
            background-color: #9D1435;
        }
        
        /* ============================================================ */
        /* LOGIN SCREEN                                                */
        /* Overlay shown before authentication                        */
        /* ============================================================ */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--color-primary) 0%, #051f3c 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .login-form-wrapper {
            background-color: var(--color-white);
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 40px;
            max-width: 400px;
            width: 100%;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .login-logo img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .login-title {
            text-align: center;
            color: var(--color-primary);
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .login-subtitle {
            text-align: center;
            color: var(--color-medium-gray);
            font-size: 13px;
            margin-bottom: 24px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #555555;
            margin-bottom: 4px;
        }
        
        .form-input {
            width: 100%;
            border: 1px solid var(--color-border-gray);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(10, 49, 97, 0.15);
        }
        
        .form-input.error {
            border-color: var(--color-danger);
        }
        
        .login-button {
            width: 100%;
            background-color: var(--color-primary);
            color: var(--color-white);
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 24px;
        }
        
        .login-button:hover:not(:disabled) {
            background-color: #0D3D7A;
        }
        
        .login-button:disabled {
            background-color: var(--color-botswana-blue);
            cursor: not-allowed;
        }
        
        .login-error {
            color: var(--color-danger);
            font-size: 12px;
            margin-top: 8px;
            display: none;
        }
        
        .login-error.show {
            display: block;
        }
        
        /* ============================================================ */
        /* AUTHENTICATED CONTENT AREA                                  */
        /* Hidden until user logs in                                  */
        /* ============================================================ */
        .authenticated-content {
            display: none;
        }
        
        .authenticated-content.show {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* ============================================================ */
        /* MAIN CONTENT AREA                                           */
        /* Centered column with max-width per gea-brand               */
        /* ============================================================ */
        .main-content {
            flex: 1;
            padding: 32px 24px;
            max-width: 700px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* ============================================================ */
        /* PAGE SECTIONS                                               */
        /* Hidden by default, shown via showPage()                   */
        /* ============================================================ */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* ============================================================ */
        /* CARDS & PANELS                                              */
        /* Per gea-brand SKILL.md card styling                       */
        /* ============================================================ */
        .card {
            background-color: var(--color-white);
            border: 1px solid var(--color-border-gray);
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 20px 24px;
            margin-bottom: 20px;
        }
        
        .card-header {
            border-bottom: 2px solid var(--color-accent);
            padding-bottom: 12px;
            margin-bottom: 16px;
        }
        
        .card-title {
            color: var(--color-primary);
            font-size: 16px;
            font-weight: 600;
        }
        
        /* ============================================================ */
        /* HEADINGS                                                    */
        /* ============================================================ */
        h1 {
            font-size: 22px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 20px;
        }
        
        h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 16px;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 2px;
            border-bottom: 2px solid var(--color-accent);
            padding-bottom: 6px;
        }
        
        /* ============================================================ */
        /* STATUS BADGES                                               */
        /* Per gea-brand SKILL.md badge styling                      */
        /* ============================================================ */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-success {
            background-color: #E8F5E9;
            color: var(--color-success);
            border: 1px solid #C8E6C9;
        }
        
        .badge-pending {
            background-color: #FFF3E0;
            color: var(--color-warning);
            border: 1px solid #FFE0B2;
        }
        
        .badge-tentative {
            background-color: #FFF8E1;
            color: #F57F17;
            border: 1px solid #FFF176;
        }
        
        .badge-confirmed {
            background-color: #E3F2FD;
            color: var(--color-info);
            border: 1px solid #BBDEFB;
        }
        
        .badge-denied,
        .badge-cancelled {
            background-color: #FFEBEE;
            color: var(--color-danger);
            border: 1px solid #FFCDD2;
        }
        
        .badge-expired {
            background-color: #F5F5F5;
            color: var(--color-medium-gray);
            border: 1px solid var(--color-border-gray);
        }
        
        /* ============================================================ */
        /* DASHBOARD PAGE                                              */
        /* ============================================================ */
        .membership-status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }
        
        .status-item {
            padding: 16px;
            background-color: #F8FAFF;
            border-left: 5px solid var(--color-primary);
            border-radius: 4px;
        }
        
        .status-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-medium-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .status-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-primary);
        }
        
        /* ============================================================ */
        /* TABLES / DATA GRIDS                                         */
        /* Per gea-brand SKILL.md table styling                      */
        /* ============================================================ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid var(--color-border-gray);
            margin-top: 12px;
        }
        
        .data-table thead {
            background-color: var(--color-primary);
            color: var(--color-white);
        }
        
        .data-table th {
            padding: 10px 14px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .data-table td {
            padding: 10px 14px;
            border-bottom: 1px solid var(--color-border-gray);
        }
        
        .data-table tbody tr:nth-child(odd) {
            background-color: var(--color-white);
        }
        
        .data-table tbody tr:nth-child(even) {
            background-color: #F8FAFF;
        }
        
        .data-table tbody tr:hover {
            background-color: #EFF6FF;
        }
        
        /* ============================================================ */
        /* FORMS & INPUTS                                              */
        /* ============================================================ */
        .form {
            margin-top: 16px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .form-row.full {
            grid-template-columns: 1fr;
        }
        
        .form-field {
            display: flex;
            flex-direction: column;
        }
        
        .form-field label {
            font-size: 12px;
            font-weight: 600;
            color: #555555;
            margin-bottom: 4px;
        }
        
        .form-field input,
        .form-field select,
        .form-field textarea {
            border: 1px solid var(--color-border-gray);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-field input:focus,
        .form-field select:focus,
        .form-field textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(10, 49, 97, 0.15);
        }
        
        .form-field textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* ============================================================ */
        /* BUTTONS                                                     */
        /* ============================================================ */
        .button {
            padding: 10px 20px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.5px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .button-primary {
            background-color: var(--color-primary);
            color: var(--color-white);
        }
        
        .button-primary:hover:not(:disabled) {
            background-color: #0D3D7A;
        }
        
        .button-primary:disabled {
            background-color: var(--color-botswana-blue);
            cursor: not-allowed;
        }
        
        .button-danger {
            background-color: var(--color-danger);
            color: var(--color-white);
        }
        
        .button-danger:hover {
            background-color: #B71C1C;
        }
        
        .button-secondary {
            background-color: transparent;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
        }
        
        .button-secondary:hover {
            background-color: #EFF6FF;
        }
        
        /* ============================================================ */
        /* ALERTS / MESSAGES                                           */
        /* ============================================================ */
        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 16px;
            font-size: 13px;
        }
        
        .alert-info {
            background-color: #EFF6FF;
            border-left: 5px solid var(--color-primary);
            color: var(--color-primary);
        }
        
        .alert-success {
            background-color: #F1F8E9;
            border-left: 5px solid var(--color-success);
            color: var(--color-success);
        }
        
        .alert-warning {
            background-color: #FFF0F3;
            border: 2px solid var(--color-accent);
            color: var(--color-accent);
            font-weight: 600;
        }
        
        .alert-error {
            background-color: #FFEBEE;
            border-left: 5px solid var(--color-danger);
            color: var(--color-danger);
        }
        
        /* ============================================================ */
        /* RESPONSIVE DESIGN                                           */
        /* ============================================================ */
        @media (max-width: 600px) {
            .header {
                flex-wrap: wrap;
                height: auto;
                gap: 12px;
            }
            
            .header-left {
                flex: 1;
            }
            
            .header-right {
                flex: 1;
                justify-content: flex-end;
            }
            
            .membership-status-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ============================================================ -->
    <!-- LOGIN SCREEN                                               -->
    <!-- Overlay shown to unauthenticated users                    -->
    <!-- ============================================================ -->
    <div class="login-screen" id="loginScreen">
        <div class="login-form-wrapper">
            <!-- Logo: references Config.gs LOGO_ROUND_80_URL -->
            <div class="login-logo">
                <img src="<?= LOGO_ROUND_80_URL ?>" alt="GEA">
            </div>
            
            <div class="login-title">GEA Member Portal</div>
            <div class="login-subtitle">Gaborone Employee Association</div>
            
            <form id="loginForm" onsubmit="submitLogin(event)">
                <div class="form-group">
                    <label class="form-label" for="loginEmail">Email Address</label>
                    <input 
                        type="email" 
                        id="loginEmail" 
                        class="form-input" 
                        placeholder="you@state.gov"
                        required
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="loginPassword">Password</label>
                    <input 
                        type="password" 
                        id="loginPassword" 
                        class="form-input" 
                        placeholder="Enter password"
                        required
                    >
                </div>
                
                <div class="login-error" id="loginError"></div>
                
                <button 
                    type="submit" 
                    class="login-button" 
                    id="loginSubmit"
                >
                    Sign In
                </button>
            </form>
        </div>
    </div>
    
    <!-- ============================================================ -->
    <!-- MAIN APPLICATION (shown after authentication)              -->
    <!-- ============================================================ -->
    <div class="authenticated-content" id="authenticatedContent">
        <!-- ====================================================== -->
        <!-- HEADER / NAVIGATION BAR                              -->
        <!-- Logo, title, member name, household, logout button   -->
        <!-- ====================================================== -->
        <div class="header">
            <div class="header-left">
                <div class="logo-section">
                    <!-- Logo: references Config.gs LOGO_ROUND_80_URL -->
                    <div class="logo">
                        <img src="<?= LOGO_ROUND_80_URL ?>" alt="GEA">
                    </div>
                    <div class="header-title">GEA Member Portal</div>
                </div>
            </div>
            
            <div class="header-right">
                <div class="user-info">
                    <!-- MEMBER: First name and last name of logged-in user -->
                    <div class="user-label">Member</div>
                    <div class="user-name" id="headerMemberName">—</div>
                    
                    <!-- HOUSEHOLD: Name of member's household -->
                    <div class="household-name" id="headerHouseholdName">—</div>
                </div>
                
                <!-- LOGOUT: Clears session and returns to login -->
                <button class="logout-button" onclick="logout()">
                    Logout
                </button>
            </div>
        </div>
        
        <!-- ====================================================== -->
        <!-- MAIN CONTENT AREA                                    -->
        <!-- Contains all page sections                            -->
        <!-- ====================================================== -->
        <div class="main-content">
            <!-- ================================================== -->
            <!-- DASHBOARD PAGE                                   -->
            <!-- Shows membership status and upcoming events       -->
            <!-- ================================================== -->
            <div class="page active" id="dashboardPage">
                <h1>Dashboard</h1>
                
                <!-- Membership Status -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Membership Status</div>
                    </div>
                    
                    <div class="membership-status-grid">
                        <div class="status-item">
                            <div class="status-label">Type</div>
                            <div class="status-value" id="dashMembershipType">—</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Status</div>
                            <div id="dashMembershipStatus">—</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Expiration</div>
                            <div class="status-value" id="dashExpiration">—</div>
                        </div>
                        <div class="status-item">
                            <div class="status-label">Dues Balance</div>
                            <div class="status-value" id="dashBalance">—</div>
                        </div>
                    </div>
                </div>
                
                <!-- Household Members -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Household Members</div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Relationship</th>
                                <th>Photo Status</th>
                            </tr>
                        </thead>
                        <tbody id="householdMembersTable">
                            <tr>
                                <td colspan="3" style="text-align: center; padding: 20px; color: var(--color-medium-gray);">Loading members...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Upcoming Reservations -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Upcoming Reservations</div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Facility</th>
                                <th>Time</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="upcomingReservationsTable">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 20px; color: var(--color-medium-gray);">Loading reservations...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ================================================== -->
            <!-- RESERVATIONS PAGE                                -->
            <!-- Book new reservation, view all reservations       -->
            <!-- ================================================== -->
            <div class="page" id="reservationsPage">
                <h1>Reservations</h1>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">New Reservation</div>
                    </div>
                    
                    <div class="form">
                        <div class="form-row full">
                            <div class="form-field">
                                <label>Facility</label>
                                <select id="resortFacility" required>
                                    <option value="">— Select facility —</option>
                                    <option value="tennis">Tennis Court</option>
                                    <option value="leobo">Leobo Venue</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label>Date</label>
                                <input type="date" id="reservationDate" required>
                            </div>
                            <div class="form-field">
                                <label>Start Time</label>
                                <input type="time" id="reservationStartTime" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label>End Time</label>
                                <input type="time" id="reservationEndTime" required>
                            </div>
                            <div class="form-field">
                                <label>Event Name</label>
                                <input type="text" id="eventName" placeholder="e.g., Family Tennis">
                            </div>
                        </div>
                        
                        <div class="form-row full">
                            <div class="form-field">
                                <label>
                                    <input type="checkbox" id="hasGuests"> I will have guests
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-row full" id="guestCountRow" style="display: none;">
                            <div class="form-field">
                                <label>Number of Guests</label>
                                <input type="number" id="guestCount" min="0" max="50">
                            </div>
                        </div>
                        
                        <button type="submit" class="button button-primary" onclick="submitReservation(event)">
                            Submit Reservation
                        </button>
                    </div>
                </div>
                
                <!-- Reservations List -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">All Reservations</div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Facility</th>
                                <th>Time</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="allReservationsTable">
                            <tr>
                                <td colspan="5" style="text-align: center; padding: 20px; color: var(--color-medium-gray);">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ================================================== -->
            <!-- PROFILE PAGE                                     -->
            <!-- View and edit member information                  -->
            <!-- ================================================== -->
            <div class="page" id="profilePage">
                <h1>My Profile</h1>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Personal Information</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-field">
                            <label>First Name</label>
                            <input type="text" id="firstName" readonly>
                        </div>
                        <div class="form-field">
                            <label>Last Name</label>
                            <input type="text" id="lastName" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row full">
                        <div class="form-field">
                            <label>Email</label>
                            <input type="email" id="memberEmail" readonly>
                        </div>
                    </div>
                </div>
                
                <!-- Phone Numbers: NEW SECTION -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Phone Numbers</div>
                    </div>
                    
                    <div class="form-row full">
                        <div class="form-field">
                            <label>Primary Phone</label>
                            <input 
                                type="tel" 
                                id="primaryPhoneInput" 
                                placeholder="+267 71 234567"
                            >
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-field">
                            <label>
                                <input type="checkbox" id="primaryPhoneWhatsApp">
                                Primary phone has WhatsApp
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-row full">
                        <div class="form-field">
                            <label>Secondary Phone</label>
                            <input 
                                type="tel" 
                                id="secondaryPhoneInput" 
                                placeholder="+1 202 647 1234"
                            >
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-field">
                            <label>
                                <input type="checkbox" id="secondaryPhoneWhatsApp">
                                Secondary phone has WhatsApp
                            </label>
                        </div>
                    </div>
                    
                    <button type="button" class="button button-primary" onclick="savePhoneNumbers()">
                        Save Phone Numbers
                    </button>
                    <div class="alert alert-success" id="phoneMessage" style="display: none; margin-top: 12px;"></div>
                </div>
                
                <!-- Emergency Contact -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Emergency Contact</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-field">
                            <label>Name</label>
                            <input type="text" id="emergencyName" readonly>
                        </div>
                        <div class="form-field">
                            <label>Relationship</label>
                            <input type="text" id="emergencyRelationship" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-field">
                            <label>Phone</label>
                            <input type="tel" id="emergencyPhone" readonly>
                        </div>
                        <div class="form-field">
                            <label>Email</label>
                            <input type="email" id="emergencyEmail" readonly>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ================================================== -->
            <!-- MEMBERSHIP CARD PAGE                             -->
            <!-- Digital membership card for all household members  -->
            <!-- ================================================== -->
            <div class="page" id="cardPage">
                <h1>Membership Card</h1>
                
                <div id="membershipCardsContainer">
                    <!-- Cards inserted by loadCard() -->
                </div>
            </div>
            
            <!-- ================================================== -->
            <!-- PAYMENT PAGE                                     -->
            <!-- Submit payment confirmation                       -->
            <!-- ================================================== -->
            <div class="page" id="paymentPage">
                <h1>Payment</h1>
                
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Submit Payment</div>
                    </div>
                    
                    <div class="form">
                        <div class="form-row full">
                            <div class="form-field">
                                <label>Payment Method</label>
                                <select id="paymentMethod" required>
                                    <option value="">— Select method —</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <option value="check">Check</option>
                                    <option value="cash">Cash</option>
                                    <option value="credit_card">Credit Card</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-field">
                                <label>Amount</label>
                                <input type="number" id="paymentAmount" step="0.01" min="0" required>
                            </div>
                            <div class="form-field">
                                <label>Currency</label>
                                <select id="paymentCurrency" required>
                                    <option value="USD">USD</option>
                                    <option value="BWP">BWP</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row full">
                            <div class="form-field">
                                <label>Payment Date</label>
                                <input type="date" id="paymentDate" required>
                            </div>
                        </div>
                        
                        <div class="form-row full">
                            <div class="form-field">
                                <label>Reference / Check Number</label>
                                <input type="text" id="paymentReference" placeholder="Bank ref or check #">
                            </div>
                        </div>
                        
                        <div class="form-row full">
                            <div class="form-field">
                                <label>Notes</label>
                                <textarea id="paymentNotes" placeholder="Any additional details..."></textarea>
                            </div>
                        </div>
                        
                        <button type="submit" class="button button-primary" onclick="submitPayment(event)">
                            Submit Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================================
        // GLOBAL STATE & CONFIGURATION
        // ============================================================
        
        // The API URL is injected by Google Apps Script at render time
        // via the HtmlService template system (<?= ... ?>)
        var currentToken = null;
        var currentUser = null;
        var currentHousehold = null;
        
        // ============================================================
        // AUTHENTICATION: LOGIN
        // ============================================================
        
        /**
         * Submits the login form.
         * Sends the user's email and password to the backend's _handleLogin
         * action. If successful, stores the session token and shows the app.
         * If unsuccessful, shows an error message.
         */
        function submitLogin(event) {
            event.preventDefault();
            
            var email = document.getElementById('loginEmail').value.trim();
            var password = document.getElementById('loginPassword').value;
            var errorDiv = document.getElementById('loginError');
            var submitButton = document.getElementById('loginSubmit');
            
            // Clear previous error
            errorDiv.classList.remove('show');
            errorDiv.textContent = '';
            submitButton.disabled = true;
            submitButton.textContent = 'Signing in...';
            
            // Call the backend's login action
            fetch(PORTAL_API_URL + '?action=login&email=' + encodeURIComponent(email) + '&password=' + encodeURIComponent(password))
                .then(function(r) { return r.json(); })
                .then(function(res) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Sign In';
                    
                    if (!res.success) {
                        errorDiv.textContent = res.message || 'Login failed. Please check your email and password.';
                        errorDiv.classList.add('show');
                        return;
                    }
                    
                    // Store token and member info
                    currentToken = res.data.token;
                    currentUser = res.data.user;
                    currentHousehold = res.data.household;
                    
                    sessionStorage.setItem('gea_token', currentToken);
                    sessionStorage.setItem('gea_user', JSON.stringify(currentUser));
                    sessionStorage.setItem('gea_household', JSON.stringify(currentHousehold));
                    
                    // Show authenticated UI and load dashboard
                    showAuthenticatedUI();
                    loadDashboard();
                })
                .catch(function(err) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Sign In';
                    errorDiv.textContent = 'Connection error. Please try again.';
                    errorDiv.classList.add('show');
                    console.error('Login error:', err);
                });
        }
        
        /**
         * Logs out the current user.
         * Clears the session token, hides the authenticated UI, and shows login.
         */
        function logout() {
            currentToken = null;
            currentUser = null;
            currentHousehold = null;
            
            sessionStorage.removeItem('gea_token');
            sessionStorage.removeItem('gea_user');
            sessionStorage.removeItem('gea_household');
            
            document.getElementById('authenticatedContent').classList.remove('show');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
        }
        
        /**
         * Shows the authenticated content area.
         * Called after successful login. Updates the header with member/household info.
         */
        function showAuthenticatedUI() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('authenticatedContent').classList.add('show');
            
            // Update header with member name and household
            if (currentUser) {
                document.getElementById('headerMemberName').textContent = 
                    currentUser.first_name + ' ' + currentUser.last_name;
            }
            
            if (currentHousehold) {
                document.getElementById('headerHouseholdName').textContent = 
                    currentHousehold.household_name;
            }
        }
        
        // ============================================================
        // PAGE NAVIGATION
        // ============================================================
        
        /**
         * Shows a specific page by name.
         * Hides all other pages. Calls the appropriate load function.
         */
        function showPage(pageName) {
            // Hide all pages
            var pages = document.querySelectorAll('.page');
            pages.forEach(function(p) { p.classList.remove('active'); });
            
            // Show the requested page
            var page = document.getElementById(pageName + 'Page');
            if (page) {
                page.classList.add('active');
            }
            
            // Load data for the page
            if (pageName === 'dashboard') { loadDashboard(); }
            else if (pageName === 'reservations') { loadReservations(); }
            else if (pageName === 'profile') { loadProfile(); }
            else if (pageName === 'card') { loadCard(); }
        }
        
        // ============================================================
        // DASHBOARD PAGE
        // ============================================================
        
        /**
         * Loads dashboard data from the backend.
         * Displays membership status, household members, and upcoming reservations.
         */
        function loadDashboard() {
            var params = { token: currentToken };
            var url = PORTAL_API_URL + '?action=dashboard&token=' + encodeURIComponent(currentToken);
            
            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(res) {
                    if (!res.success) {
                        console.error('Dashboard error:', res.message);
                        return;
                    }
                    
                    var data = res.data;
                    
                    // Membership status
                    document.getElementById('dashMembershipType').textContent = 
                        data.household.membership_type || '—';
                    document.getElementById('dashMembershipStatus').innerHTML = 
                        '<span class="badge badge-' + (data.household.active ? 'success' : 'expired') + '">' + 
                        (data.household.active ? 'Active' : 'Inactive') + 
                        '</span>';
                    document.getElementById('dashExpiration').textContent = 
                        data.household.membership_expiration_date || '—';
                    document.getElementById('dashBalance').textContent = 
                        '$' + (data.household.balance_due || '0.00').toFixed(2);
                    
                    // Household members table
                    var membersHtml = '';
                    (data.members || []).forEach(function(m) {
                        membersHtml += '<tr>';
                        membersHtml += '<td>' + m.first_name + ' ' + m.last_name + '</td>';
                        membersHtml += '<td>' + m.relationship_to_primary + '</td>';
                        membersHtml += '<td><span class="badge badge-' + (m.photo_status || 'none').toLowerCase() + '">' + (m.photo_status || 'None') + '</span></td>';
                        membersHtml += '</tr>';
                    });
                    document.getElementById('householdMembersTable').innerHTML = membersHtml || '<tr><td colspan="3" style="text-align:center; padding:20px;">No members found</td></tr>';
                    
                    // Upcoming reservations table
                    var resHtml = '';
                    (data.upcomingReservations || []).forEach(function(r) {
                        resHtml += '<tr>';
                        resHtml += '<td>' + r.reservation_date + '</td>';
                        resHtml += '<td>' + r.facility + '</td>';
                        resHtml += '<td>' + r.start_time + ' - ' + r.end_time + '</td>';
                        resHtml += '<td><span class="badge badge-' + (r.status || 'pending').toLowerCase() + '">' + (r.status || 'Pending') + '</span></td>';
                        resHtml += '</tr>';
                    });
                    document.getElementById('upcomingReservationsTable').innerHTML = resHtml || '<tr><td colspan="4" style="text-align:center; padding:20px;">No upcoming reservations</td></tr>';
                })
                .catch(function(err) {
                    console.error('Dashboard fetch error:', err);
                });
        }
        
        // ============================================================
        // RESERVATIONS PAGE
        // ============================================================
        
        /**
         * Loads reservations data from the backend.
         * Displays all reservations for the member.
         */
        function loadReservations() {
            var url = PORTAL_API_URL + '?action=reservations&token=' + encodeURIComponent(currentToken);
            
            // Show/hide guest count field based on checkbox
            document.getElementById('hasGuests').addEventListener('change', function(e) {
                var row = document.getElementById('guestCountRow');
                row.style.display = e.target.checked ? 'grid' : 'none';
            });
            
            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(res) {
                    if (!res.success) {
                        console.error('Reservations error:', res.message);
                        return;
                    }
                    
                    var resHtml = '';
                    (res.data.reservations || []).forEach(function(r) {
                        resHtml += '<tr>';
                        resHtml += '<td>' + r.reservation_date + '</td>';
                        resHtml += '<td>' + r.facility + '</td>';
                        resHtml += '<td>' + r.start_time + ' - ' + r.end_time + '</td>';
                        resHtml += '<td><span class="badge badge-' + (r.status || 'pending').toLowerCase() + '">' + (r.status || 'Pending') + '</span></td>';
                        resHtml += '<td><button class="button button-secondary button-small" onclick="cancelReservation(\'' + r.reservation_id + '\')">Cancel</button></td>';
                        resHtml += '</tr>';
                    });
                    document.getElementById('allReservationsTable').innerHTML = resHtml || '<tr><td colspan="5" style="text-align:center; padding:20px;">No reservations</td></tr>';
                })
                .catch(function(err) {
                    console.error('Reservations fetch error:', err);
                });
        }
        
        /**
         * Submits a new reservation.
         */
        function submitReservation(event) {
            event.preventDefault();
            
            var params = {
                token: currentToken,
                facility: document.getElementById('resortFacility').value,
                reservation_date: document.getElementById('reservationDate').value,
                start_time: document.getElementById('reservationStartTime').value,
                end_time: document.getElementById('reservationEndTime').value,
                event_name: document.getElementById('eventName').value,
                guest_count: document.getElementById('hasGuests').checked ? 
                    parseInt(document.getElementById('guestCount').value) : 0
            };
            
            var url = PORTAL_API_URL + '?' + new URLSearchParams(params).toString() + '&action=book';
            
            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(res) {
                    if (!res.success) {
                        alert('Error: ' + res.message);
                        return;
                    }
                    
                    alert('Reservation submitted successfully!');
                    document.getElementById('loginForm').reset();
                    loadReservations();
                })
                .catch(function(err) {
                    alert('Error submitting reservation: ' + err);
                    console.error('Submit reservation error:', err);
                });
        }
        
        /**
         * Cancels a reservation.
         */
        function cancelReservation(reservationId) {
            if (!confirm('Cancel this reservation?')) return;
            
            var url = PORTAL_API_URL + '?action=cancel&token=' + encodeURIComponent(currentToken) + 
                '&reservation_id=' + encodeURIComponent(reservationId);
            
            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(res) {
                    if (!res.success) {
                        alert('Error: ' + res.message);
                        return;
                    }
                    
                    alert('Reservation cancelled.');
                    loadReservations();
                })
                .catch(function(err) {
                    console.error('Cancel error:', err);
                });
        }
        
        // ============================================================
        // PROFILE PAGE
        // ============================================================
        
        /**
         * Loads profile data from the backend.
         * Displays personal info, phone numbers, and emergency contact.
         */
        function loadProfile() {
            var url = PORTAL_API_URL + '?action=profile&token=' + encodeURIComponent(currentToken);
            
            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(res) {
                    if (!res.success) {
                        console.error('Profile error:', res.message);
                        return;
                    }
                    
                    var data = res.data;
                    
                    // Personal info
                    document.getElementById('firstName').value = data.first_name || '';
                    document.getElementById('lastName').value = data.last_name || '';
                    document.getElementById('memberEmail').value = data.email || '';
                    
                    // Phone numbers
                    document.getElementById('primaryPhoneInput').value = 
                        '+' + (data.country_code_primary || 'BW') + ' ' + (data.phone_primary || '');
                    document.getElementById('primaryPhoneWhatsApp').checked = 
                        data.phone_primary_whatsapp || false;
                    document.getElementById('secondaryPhoneInput').value = 
                        '+' + (data.country_code_secondary || '') + ' ' + (data.phone_secondary || '');
                    document.getElementById('secondaryPhoneWhatsApp').checked = 
                        data.phone_secondary_whatsapp || false;
                    
                    // Emergency contact
                    document.getElementById('emergencyName').value = data.emergency_contact_name || '';
                    document.getElementById('emergencyRelationship').value = data.emergency_contact_relationship || '';
                    document.getElementById('emergencyPhone').value = data.phone_emergency || '';
                    document.getElementById('emergencyEmail').value = data.emergency_contact_email || '';
                })
                .catch(function(err) {
                    console.error('Profile fetch error:', err);
                });
        }
        
        /**
         * Saves phone numbers to the backend.
         * Parses intl-tel-input format and extracts country code and phone number.
         */
        function savePhoneNumbers() {
            var primaryInput = document.getElementById('primaryPhoneInput').value.trim();
            var secondaryInput = document.getElementById('secondaryPhoneInput').value.trim();
            var messageDiv = document.getElementById('phoneMessage');
            
            messageDiv.style.display = 'none';
            
            // TODO: Parse intl-tel-input formatted phone numbers
            // For now, simple regex extraction
            
            var params = {
                token: currentToken,
                country_code_primary: 'BW',  // TODO: extract from input
                phone_primary: primaryInput,  // TODO: extract digits only
                phone_primary_whatsapp: document.getElementById('primaryPhoneWhatsApp').checked,
                country_code_secondary: '',  // TODO: extract
                phone_secondary: secondaryInput,  // TODO: extract digits only
                phone_secondary_whatsapp: document.getElementById('secondaryPhoneWhatsApp').checked
            };
            
            var url = PORTAL_API_URL + '?' + new URLSearchParams(params).toString() + '&action=updatePhoneNumbers';
            
            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(res) {
                    if (!res.success) {
                        messageDiv.textContent = 'Error: ' + res.message;
                        messageDiv.classList.remove('alert-success');
                        messageDiv.classList.add('alert-error');
                        messageDiv.style.display = 'block';
                        return;
                    }
                    
                    messageDiv.textContent = 'Phone numbers saved successfully!';
                    messageDiv.classList.remove('alert-error');
                    messageDiv.classList.add('alert-success');
                    messageDiv.style.display = 'block';
                })
                .catch(function(err) {
                    console.error('Phone update error:', err);
                    messageDiv.textContent = 'Connection error. Please try again.';
                    messageDiv.style.display = 'block';
                });
        }
        
        // ============================================================
        // MEMBERSHIP CARD PAGE
        // ============================================================
        
        /**
         * Loads and displays digital membership cards for all household members.
         */
        function loadCard() {
            var url = PORTAL_API_URL + '?action=card&token=' + encodeURIComponent(currentToken);
            
            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(res) {
                    if (!res.success) {
                        console.error('Card error:', res.message);
                        return;
                    }
                    
                    var html = '';
                    (res.data.members || []).forEach(function(m) {
                        html += '<div class="card">';
                        html += '<div style="display:flex; justify-content:space-between; align-items:center;">';
                        html += '<div>';
                        html += '<div style="font-weight:700; font-size:16px;">' + m.first_name + ' ' + m.last_name + '</div>';
                        html += '<div style="color:#757575; font-size:12px;">' + m.relationship_to_primary + '</div>';
                        html += '</div>';
                        html += '<div style="text-align:right;">';
                        html += '<span class="badge badge-success">Active</span>';
                        html += '</div>';
                        html += '</div>';
                        html += '</div>';
                    });
                    
                    document.getElementById('membershipCardsContainer').innerHTML = html;
                })
                .catch(function(err) {
                    console.error('Card fetch error:', err);
                });
        }
        
        // ============================================================
        // PAYMENT PAGE
        // ============================================================
        
        /**
         * Submits a payment confirmation.
         */
        function submitPayment(event) {
            event.preventDefault();
            
            var params = {
                token: currentToken,
                payment_method: document.getElementById('paymentMethod').value,
                amount: parseFloat(document.getElementById('paymentAmount').value),
                currency: document.getElementById('paymentCurrency').value,
                payment_date: document.getElementById('paymentDate').value,
                payment_reference: document.getElementById('paymentReference').value,
                notes: document.getElementById('paymentNotes').value
            };
            
            var url = PORTAL_API_URL + '?' + new URLSearchParams(params).toString() + '&action=payment';
            
            fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(res) {
                    if (!res.success) {
                        alert('Error: ' + res.message);
                        return;
                    }
                    
                    alert('Payment submitted! The board will verify and process soon.');
                    document.getElementById('paymentForm').reset();
                })
                .catch(function(err) {
                    alert('Error submitting payment: ' + err);
                    console.error('Payment submission error:', err);
                });
        }
        
        // ============================================================
        // INITIALIZATION
        // ============================================================
        
        /**
         * On page load, check if user is already logged in via sessionStorage.
         * If so, show the authenticated UI. Otherwise, show login screen.
         */
        window.addEventListener('load', function() {
            var token = sessionStorage.getItem('gea_token');
            var user = sessionStorage.getItem('gea_user');
            var household = sessionStorage.getItem('gea_household');
            
            if (token && user && household) {
                currentToken = token;
                currentUser = JSON.parse(user);
                currentHousehold = JSON.parse(household);
                showAuthenticatedUI();
                loadDashboard();
            }
        });
    </script>
</body>
</html>
